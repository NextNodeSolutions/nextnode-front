name: PR Preview

on:
    pull_request:
        types: [opened, synchronize, reopened]
        branches: [develop, main]

jobs:
    quality-checks:
        name: Quality Checks
        if: github.head_ref != 'develop'
        uses: NextNodeSolutions/github-actions/.github/workflows/quality-checks.yml@main
        with:
            run-lint: true
            run-typecheck: true
            run-tests: true
            run-build: true
        secrets: inherit

    preview:
        name: Deploy Preview
        needs: quality-checks
        if: github.head_ref != 'develop'
        uses: NextNodeSolutions/github-actions/.github/workflows/app-deploy.yml@main
        with:
            environment: preview
            pr-number: ${{ github.event.pull_request.number }}
        secrets: inherit

    comment:
        name: Comment Preview URL
        needs: preview
        if: needs.preview.outputs.success == 'true'
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write
        steps:
            - uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: `## Preview Ready\n\nURL: https://${{ needs.preview.outputs.domain }}\n\nAuto-cleanup on PR close.`
                      })
