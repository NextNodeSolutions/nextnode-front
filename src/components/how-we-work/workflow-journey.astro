---
import {
	STEP_COLORS,
	DESKTOP_WORKFLOW_POSITIONS,
	generateGradientStops,
	type Step,
} from '@/lib/workflow-constants'
import { generateSteps, generateDetailedSteps } from '@/lib/workflow-utils'

import WorkflowGradients from './WorkflowGradients.astro'
import WorkflowPath from './WorkflowPath.astro'
import TimelineNode from './TimelineNode.astro'
import StepCardContainer from './StepCardContainer.astro'

// Données des étapes avec traductions
const steps: Step[] = generateSteps()
const detailedSteps = generateDetailedSteps()
const positions = DESKTOP_WORKFLOW_POSITIONS
const gradientStops = generateGradientStops(STEP_COLORS)

// Taille estimée des StepCard mini (pour positionnement)
const MINI_CARD_WIDTH = 220
const MINI_CARD_HEIGHT = 120
---

<div class="workflow-journey relative w-full py-8 md:py-12 lg:py-16">
	<div class="container mx-auto px-4">
		<!-- SVG Background avec chemin et lignes -->
		<svg
			class="aspect-[2/1] w-full"
			viewBox="0 -50 1000 500"
			style="overflow: visible;"
			xmlns="http://www.w3.org/2000/svg"
		>
			<WorkflowGradients gradientStops={gradientStops} />
			<WorkflowPath />

			{/* Lignes de connexion et points sur le chemin */}
			{
				positions.map((position, index) => {
					const color = STEP_COLORS[index]

					return (
						<g key={index}>
							{/* Ligne de connexion */}
							<line
								x1={position.x}
								y1={position.y}
								x2={position.lineEndX}
								y2={position.lineEndY}
								stroke={color}
								stroke-width="3"
								opacity="1"
							/>

							{/* Point sur le chemin */}
							<circle
								cx={position.x}
								cy={position.y}
								r="6"
								fill={color}
								stroke="white"
								stroke-width="3"
							/>
						</g>
					)
				})
			}
		</svg>

		<!-- StepCards positionnées en HTML au-dessus -->
		<div class="absolute inset-0">
			{
				detailedSteps.map((step, index) => {
					const position = positions[index]
					const color = STEP_COLORS[index]

					if (!position || !color) {
						return null
					}

					// Utiliser directement les coordonnées SVG (beaucoup plus simple)

					return (
						<div
							class="absolute"
							style={`left: ${position.cardX}px; top: ${position.cardY}px; width: ${MINI_CARD_WIDTH}px; height: ${MINI_CARD_HEIGHT}px;`}
						>
							<StepCardContainer
								stepKey={step.id}
								index={index}
								variant="mini"
							/>
						</div>
					)
				})
			}
		</div>
	</div>
</div>

<style>
	/* Styles simples et propres pour le workflow journey */
	.workflow-journey {
		user-select: none;
	}

	.step-card-group {
		opacity: 1;
	}

	/* Interactive card hover effects */
	.interactive-card {
		cursor: pointer;
	}

	/* Responsive adjustments */
	@media (max-width: 768px) {
		.workflow-journey svg {
			height: 400px;
		}

		.expanded-content {
			width: 350px !important;
			height: 250px !important;
			x: 50 !important;
			y: 125 !important;
		}
	}
</style>
